<!DOCTYPE html>
<html>
<head>
      <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>ACLAP</title>
        
   
<!-- jquary -->
<script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>

<!-- pagination -->
<script type="text/javascript" src="../js/jquery.twbsPagination.min.js"></script>

<!-- icon -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js" crossorigin="anonymous"></script>

<script src="https://smtpjs.com/v3/smtp.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

<!-- script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="../js/scripts.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js" crossorigin="anonymous"></script>

<!-- pagination -->
<script type="text/javascript" src="../js/jquery.twbsPagination.min.js"></script>

<!-- 커스텀 CSS -->
<link rel="stylesheet" href="../css/managerPage.css">
<link rel="stylesheet" href="../css/mypage.css">

<script type="text/javascript">
(function() {
emailjs.init("user_ZyFYDtGep3QSZfIgncD2e");
})();
</script>
</head>

<body>
<div id='naviBar'></div>

<!-- 왼쪽 네비바 -->
<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
    	<nav class="sb-sidenav accordion sb-sidenav-dark" id="leftMenuNav">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <div class="sb-sidenav-menu-heading">Manager Page</div>
                    <a class="nav-link" href="javascript:void(0);" id="goClassList">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Class List
                    </a>
                    <a class="nav-link" href="javascript:void(0);" id="goUserList">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Users
                    </a>
                    <a class="nav-link" href="javascript:void(0)" id="goQnaList">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Questions
                    </a>
                   
                </div>
            </div>
        </nav>
    </div>
   
    <div id="layoutSidenav_content">
          <main>
            <div class="container-fluid">
                <h1 class="mt-4" id="managerPage">Manager Page</h1>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-table mr-1"></i>
                   		One-Day Class List
                    </div>
                    <!-- 메인 컨텐츠 -->
                    <div class="card-body" >
                    <div class="table-responsive">
                    	<div class="row">
                    		<div class="col-sm-12 col-md-6">
                     		<div id="dataTable_filter" class="dataTables_filter">
                     			<label>
                     				<table>
                     					<tr>
                     						<td>NAME&nbsp;:&nbsp; </td>
                     						<td><input type="search" id="userName" class="form-control form-control-sm" placeholder aria-controls="dataTable">
                     						<input type="search" id="className" class="form-control form-control-sm" placeholder aria-controls="dataTable"></td>
                     						<td>:&nbsp;<button type="button" id="btnClassSearch" class="btn btn-light">search</button></td>
                     					</tr>
                     				</table>
                     			</label>
                     		</div>
                    		</div>
                    	</div>
                        
                       <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                           <tbody id="classList"></tbody>
                       </table>
                       <div class="container" id="userPagination">
							<nav aria-label="Page navigation">
								<ul class="userPagination" style="justify-content:center;"></ul>
							</nav>
					    </div>
					    <div class="container" id="classPagination">
							<nav aria-label="Page navigation">
								<ul class="classPagination" style="justify-content:center;"></ul>
							</nav>
					    </div>
                      </div>
                    </div>
                    <!-- ///////////// 메인 컨텐츠 끝 ///////////// -->
                   </div>
               </div>
           </main>
     </div>       



    <div id="noticeCheckCheck">
        <div style="padding-top: 100px;">
	    <div class='noticeTitle'>Question</div>
			<!--검색 -->
			<div class="search">
				<table>
					<tr>
						<td style="padding-left: 5px">
							<select id="_choice" name="choice" class="form-select">
								<option value="" selected="selected">검색 선택</option>
								<option value="title">제목</option>
								<option value="content">내용</option>
								<option value="writer">작성자</option>
							</select>
						</td>
						<td style="padding-left: 5px">
							<input type="text" id="_searchWord" name="searchWord">
						</td>
						<td style="padding-left: 5px">
							<span class="button blue">
								<button type="button" id="btnSearch" class="Qbtn">검색</button>
							</span>
						</td>
					</tr>
				</table>
			</div>
			<!-- 테이블 -->
			<div class="mainTable">
				<table class="customTable" id="noticeTable">
					
					
					<tr>
						<th>번호</th><th>제목</th><th>작성자</th><th>이메일</th>
					</tr>
					
				</table>
			</div>
		
			<br><br>

			<div class="container">
				<nav aria-label="Page navigation">
					<ul class="pagination" style="justify-content:center;"></ul>
				</nav>
			</div>
		</div>
     </div>
</div>             
 

                   





        
<!-- 문의 디테일 모달 -->
<div id="detailModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
			<table class="customTable" id="detailTable">
					<colgroup>			
						<col style="width:50px">
						<col style="width:90px">
					</colgroup>	
				<tr>
					<th>문의번호</th>
					<td><input type='text' size="20" id="_noticeNum" name="noticeNum" readonly="readonly"></td>
				</tr>
				<tr>
					<th>유저번호</th>
					<td><input type='text' size="20" id="_memNum" name="memNum" readonly="readonly"></td>
				</tr>
		        <tr>
		        <th>유저네임</th>
		        <td><input type='text' size="20" id="_username" name="detailUsername" readonly="readonly"></td>
		        </tr>
		         <tr>
		        <th>이메일</th>
		        <td><input type='text' size="20" id="_email" name="detalEmail" readonly="readonly"></td>
		        </tr>
		        <tr>
		        <th>제목</th>
		        <td><input type='text' size="20" id="_ntitle" name="title" readonly="readonly"></td>
		        </tr>
		        <tr>
					<th>작성일</th>
					<td><input type='text' size="20" id="_wdate" name="wdate" readonly="readonly"></td>
				</tr>
				
				<tr>
		        <th>내용</th>
		        <td><textarea rows="10" cols="30" id="_ncontent" name="content" readonly="readonly"></textarea>
		        
		        </tr>
		        
		        
		          
          	</table>
            </div>
            <div class="modal-footer">
           
            	<input type="button" class="btn btn-secondary" id="updatebtn" value="수정">
            	<input type="button" class="btn btn-secondary" id="answerbtn" value="답변하기">
            	<button type="button" class="btn btn-secondary" id="deletebtn">삭제</button>
                <button type="button" class="btn btn-secondary" id="closebtn">Close</button>
            </div>
        </div>
    </div>
</div>	

<!-- 회원정보수정 Modal 2 (정보 입력 View) -->
<div class="modal fade" id="memberUpdateModal">
  <div class="modal-dialog">
     <div class="modal-content">
       <div class="modal-header">
         <h4 class="modal-title">회원정보 수정</h4>
       </div>        
       <div class="modal-body">
       
       <form id='myPageUserUpdate'>
        <input type='hidden' name='memNum' id='_memNums'>
        <input type='hidden' name='oldProfilePic' id='_oldProfilePic'>
        <input type='hidden'  id='_checkNname'>
       
       	<label for="profile" class='updateFont'>Profile</label> 
       	<br style='padding-bottom:1px'>
	   	<input type="file" name="fileload" class="profile2" id="_profilePic" style="display: none" >	            
	    <label for="_profilePic"> 
	   	<img id="newprofile" class="profile">
	    </label>
	    <br>        
	    
        <label class='updateFont'>UserName</label>
        <input type='text' class="form-inline newInput" name='userName' id='newUserName' size='60px'>
         
       	<label class='updateFont'>NickName</label>
        <input type='text' class="form-inline newInput" name='nickName' id='newNickName' size='60px'>
                 
       	<label class='updateFont'>Email</label>
        <input type='text' class="form-inline holdInput" name='email' id='originalEmail' size='60px' readonly>
  
       	<label class='updateFont'>Password</label>
        <input type='password' class="form-inline newInput" name='pwd' id='newPwd' size='60px'>
         
        <label class='updateFont'>Confirm Password</label>
        <input type='password' class="form-inline newInput" id='newCpwd' size='60px'>
         
        <label class='updateFont'>Phone Number</label>
        <input type='text' class="form-inline newInput" name='phoneNum' id='newPhoneNum' size='60px'>
        
        <br>
        <input type='button' class='btn btn-light' id='memberUpdateBtn' style='float:right' value='수정완료'>
        <input type='button' class='btn btn-light' id='memberDropOut' style='float:right' value='회원탈퇴'>
       </form>
       </div>
     </div>
   </div>
</div>

<div id='footer'></div>

<!-- <script src="demo/datatables-demo.js"></script> -->

 
<script type="text/javascript">
$("#naviBar").load("../navibar.html");
$("#footer").load("../footer.html");


$(document).ready(function () {

	goClassList();	
	
	$("#goClassList").on('click', function(){
		goClassList();
	});
	
	$("#goUserList").on('click',function(){
		goUserList();
	});


	//--------------------------사이드 유저리스트 검색했을 때
	function goUserList(){	
		$("#layoutSidenav_content").show();
		$("#noticeCheckCheck").hide();
		
		$('#userName').show();
		$("#className").hide();
		
		$("#userPagination").show();
		$("#classPagination").hide();
		$('#btnClassSearch').attr('id', 'btnSearchUser');
	   	$(".card-header").text("User List");
	  	$("#managerPage").text("User List");

	   
	   $("#dataTable").empty();
	   let table = "<thead>"
	            + "<tr>"
	            + "<th>#</th>"
	            + "<th>이름</th>"
	            + "<th>닉네임</th>"
	            + "<th>클래스 개설</th>"
	            + "<th>포인트</th>"
	            + "<th>이메일</th>"
	            + "<th>전화번호</th>"
	            + "<th>상태</th>"
	            + "</tr>"
	            + "</thead>";
	   
	            $("#dataTable").append(table);
	            $("#dataTable").append("<tbody id='classList'></tbody>"); // 태그 추가
	            getUserListData(0);
	            countUserList();
	}
	
	// 처음에 유저목록 다 보여줌
	function getUserListData(pgNumber){
		//$("#mainScr").load("../adminPageView/adminCListUList.html");
	      $.ajax({
	         url:"http://localhost:3000/memlist",
	         type:"get",
	         data:{ name:$("#userName").val(), page:pgNumber},
	         success:function(list){
	            //alert(list);
	            $('.classtrtrtr').remove();
	            $('.usertrtrtr').remove();
	            $.each(list, function(i, list){
	               let master = "";
	               if(list.classMaster==0)
	            	   master = "O";
	               else
	            	   master = "X";

	    	       // 계정 상태
	               let status = "";
	               
	               if(list.del==0){
	            	   status = "<td>이용</td>";
	               }else{
	            	   status = "<td>탈퇴</td>";
	               }
	            	
	               let str = "<tr class='usertrtrtr'>"
	                     + "<td>" + (i+1) + "</td>"
	                     + "<td>" + list.userName + "</td>"
	                     + "<td class='nName' seq="+list.memNum+">" + list.nickName + "</td>"
	                     + "<td>" + master + "</td>"
	                     + "<td>" + list.myPoint + "</td>"
	                     + "<td>" + list.email + "</td>"
	                     + "<td>" + list.phoneNum + "</td>"
	                     + status
	                     + "</tr>";
	               $("#classList").append(str);                  
	            });         
	            
	         	// 유저 정보 수정
				$('.nName').on('click',function(){
					let seq = $(this).attr('seq');
				//	alert(seq);
					setMemInfo(seq);
					$("#memberUpdateModal").modal('show');
	            });
	            
	         },
	         error:function(){
	            alert('userlist실패쓰ㅜ');
	         }
	      });
	}
	            
 	
	/////////////////////////// 정보 수정 (회원정보 수정)  ///////////////////////////////
    
	// 회원정보 수정 초기화 값 셋팅 
	function setMemInfo(seq){
		$.ajax({
	        url:"http://localhost:3000/myinfo",
	        type:"post",
	        data:{ memNum:seq},
	        success:function(data){
				$("#newprofile").attr('src', data.profilePic);
				$("#_oldProfilePic").val(data.profilePic);
				$("#_memNums").val(data.memNum);
				$("#newUserName").val(data.userName);
				$("#newNickName").val(data.nickName);
				$("#_checkNname").val(data.nickName);
				$("#originalEmail").val(data.email);
				$("#newPwd").val(data.pwd);
				$("#newCpwd").val(data.pwd);
				$("#newPhoneNum").val(data.phoneNum);
	        },
	        error:function(){
	        	alert('managerpage myinfo ajax error')
	        }
		});
	};
	
	
	// 프로필 이미지 미리보기
	$("#_profilePic").on("change", handleImgFileSelect);
	function handleImgFileSelect(e) {
		
		let files = e.target.files;
		let filesArr = Array.prototype.slice.call(files);
		filesArr.forEach(function(f) {
		   if(!f.type.match("image.*")) {
		       alert("이미지만 업로드 가능합니다.");
		       return;
		   }
		   sel_file = f;
		   let reader = new FileReader();
		   reader.onload = function(e) {
		        $("#newprofile").attr("src", e.target.result);   
		   }
		   reader.readAsDataURL(f);
		});
	}


	// 회원정보 수정 입력 값 빈 칸 체크
	$("#memberUpdateBtn").click(function(){
		if($("#newUserName").val() == ""){
			alert('이름을 입력하세요');
			$("#newUserName").focus();
		}
		else if($("#newNickName").val() == ""){
			alert('닉네임을 입력하세요');
			$("#newNickName").focus();
		}
		else if($("#newPwd").val() == ""){
			alert('비밀번호를 입력하세요');
			$("#newPwd").focus();
		}
		else if($("#newPhoneNum").val() == ""){
			alert('전화번호를 입력하세요');
			$("#newPhoneNum").focus();
		}
		else {
			inputCheck();
		}
	});

	
	// 회원정보 수정 입력 값 중복확인 & 정규식 체크
	function inputCheck(){
		let pwdCheck = /^[a-zA-Z0-9]{4,12}$/; // pwassword 정규식
		let phoneCheck = /^01([0|1|6|7|8|9]?)?([0-9]{3,4})?([0-9]{4})$/; // 휴대전화 정규식
		let nickName = $("#newNickName").val();
		let originalNname = $("#_checkNname").val();
		$.ajax({
			url:"http://localhost:3000/checkNickName", 
			type:'post',
			data:{nickName:nickName},
			success:function( data ){
				if(nickName != originalNname && data == 1){
					alert("사용중인 닉네임 입니다");
					$("#newNickName").val("");
					$("#newNickName").focus();
				}
				else if($("#newPwd").val() != $("#newCpwd").val()){ 
					alert("비밀번호가 동일하지 않습니다");
					$("#newPwd").val("");
					$("#newPwd").focus();
				}
				else if(!pwdCheck.test($("#newPwd").val())){
					alert("패스워드는 4~12자의 영문 대소문자와 숫자만 가능합니다");
					$("#newPwd").val("");
					$("#newPwd").focus();
				}
				else if(!phoneCheck.test($("#newPhoneNum").val())){
					alert("올바른 전화번호를 입력하세요");
					$("#newPhoneNum").val("");
					$("#newPhoneNum").focus();
				}
				else{
					memberUpdateAf();
				}
			},
			error:function(){
				alert('inputCheck Check ajax error');
			}
		});
	}
	
	
	// 회원정보 수정 AF
	function memberUpdateAf(){
	$.ajax({
		url:"http://localhost:3000/myPageUserUpdate", 
		type:'post',
		data : new FormData($("#myPageUserUpdate")[0]), 
		enctype : 'multipart/form-data',
		processData : false,
		contentType : false,
		cache : false,
		success:function( data ){
			if(data){
				alert('성공적으로 수정되었습니다');
				location.reload();
			}
			else{
				alert("수정 실패");
			}
		},
		error:function(){
			alert('memberUpdateAf ajax error');
		}
	});
	}
	
	
	// 회원 탈퇴
	$("#memberDropOut").click(function(){
		let dropOut = confirm('정말로 탈퇴 하시겠습니까');
		if(dropOut){
			$.ajax({
				url:"http://localhost:3000/memberDropOut", 
				type:'post',
				data:{memNum:$("#_memNums").val()},
				success:function( data ){
					if(data>0){
						alert('성공적으로 탈퇴 되었습니다');
					}
					else{
						alert('회원 탈퇴 실패');
					}
				},
				error:function(){
					alert('memberDropOut ajax Error')
				}
			});
		}
		else{
			$('#memberUpdateModal').modal('hide');
		}
	});
	
	// ===============================================================

	
	function countUserList() {
		$.ajax({
			url:"http://localhost:3000/userCount",
			type:"get",
			data:{page:0, name:$("#userName").val()},
			success:function(count){
				loadPage3(count);
			},
			error:function(){
				alert("에러");
			}
		}); 
	}
	
	//paging class 처리
	function loadPage3( totalCount ) {
	
		let pageSize = 10;
		let nowPage = 1;
		
		let _totalPages = totalCount / pageSize;
		if(totalCount % pageSize > 0){
			_totalPages++;
		}
		$(".userPagination").twbsPagination('destroy'); //페이지 갱신: 초기화
		
		$(".userPagination").twbsPagination({
		//	startPage: 1,
			totalPages: _totalPages,
			visiblePages: 10,
			first:'<span sria-hidden="true">«</span>',
			prev:"이전",
			next:"다음",
			last:'<span sria-hidden="true">»</span>',
			initiateStartPageClick:false,		// onPageClick 자동 실행되지 않도록 한다
			onPageClick:function(event, page){
				nowPage = page;
			//	alert('nowPage:' + page);
				getUserListData( page - 1 );
			}
		});	
	}
	
	// 유저 이름 검색했을 때 
	$(document).on("click", "#btnSearchUser", function () { 
		 getUserListData(0);
         countUserList();
	});
	
	
	
	
	
	
	
	//----------------------------사이드바  원데이 클래스 클릭시 
	function goClassList(){
	    //$("#mainScr").load("../adminPageView/adminCListUList.html");
		$("#layoutSidenav_content").show();
		$("#noticeCheckCheck").hide();
		
		$('#userName').hide();
		$("#className").show();
		
		$("#userPagination").hide();
		$("#classPagination").show();
		$(".card-header").text("One-Day Class List");
		$("#managerPage").text("One-Day Class List");
		$("#dataTable").empty();
		   let table = "<thead>"
		            + "<tr>"
		            + "<th>#</th>"
		            + "<th>개설자</th>"
		            + "<th>제목</th>"
		            + "<th>대분류</th>"
		            + "<th>소분류</th>"
		            + "<th>수업 시작일</th>"
		            + "<th>수업 종료일</th>"
		            + "<th>장소</th>"
		            + "<th>중단/재개</th>"
		            + "</tr>"
		            + "</thead>";
		   

		    $("#dataTable").append(table);
		    $("#dataTable").append("<tbody id='classList'></tbody>"); // 태그 추가
	
		    $('#btnUserSearch').attr('id', 'btnClassSearch');    
					
		    classlist(0);
		    countClassList();
		        
	}            
		
	//----------- 클래스 리스트 뿌리기------------
	function classlist(pNum) {
		$.ajax({
			url:"http://localhost:3000/classlist",
			type:"get",
			data:{ name:$("#className").val(), page:pNum},
			success:function(list){
				
				$('.classtrtrtr').remove();
				$('.usertrtrtr').remove();
				
				$.each(list, function(i, list){
					
					let startDate = (list.startDate).substring(0, 10);
					let endDate = (list.endDate).substring(0, 10);
					let del = "";
					
			        if(list.del==0)
						del = "<td><input type='button' seq="+list.classNum+" class='delClass' value='중단'></td>"
					else if(list.del==1)
						del = "<td><input type='button' seq="+list.classNum+" class='reStartClass' value='재개'></td>"
					
					let str = "<tr class='classtrtrtr'>"
							+ "<td>" + (i+1) + "</td>"
							+ "<td>" + list.instructor + "</td>"
							+ "<td class='goD' seq="+list.classNum+">" + list.title + "</td>"
							+ "<td>" + list.primaryCategory + "</td>"
							+ "<td>" + list.secondaryCategory + "</td>"
							+ "<td>" + startDate + "</td>"
							+ "<td>" + endDate  + "</td>"
							+ "<td>" + list.location + "</td>"
							+ del
							+ "</tr>";
					$("#classList").append(str);	
				});
				
				// 클래스 중단
				$('.delClass').on('click',function(){
					let check = confirm('정말로 중단하겠습니다');
					let seq = $(this).attr('seq');
					if(check){
						$.ajax({
							url:"http://localhost:3000/onedayClassDelete",
							type:"get",
							data:{classNum:seq},
							success:function(result){
								if(result){
									alert('성공적으로 중단했습니다');
									location.reload();									
								}
							},
							error:function(){
								alert("onedayClassMasterDel ajax error");
							}
						}); 
					}
				}); 
				
				// 클래스 재개
				$('.reStartClass').on('click',function(){
					let check = confirm('정말로 재개하겠습니까');
					let seq = $(this).attr('seq');
					if(check){
						$.ajax({
							url:"http://localhost:3000/onedayClassRestart",
							type:"get",
							data:{classNum:seq},
							success:function(result){
								if(result){
									alert('성공적으로 재개하였습니다');
									location.reload();									
								}
							},
							error:function(){
								alert("onedayClassMasterDel ajax error");
							}
						}); 
					}
				}); 
				
				// 클래스 수정
				$(".goD").click(function(){
					let seq = $(this).attr('seq');
					location.href="../onedayClassView/onedayClassUpdate.html?seq="+seq;
				})
				
			},
			error:function(){
				alert('classlist ajax error');
			}		
				
		});	
	}

	function countClassList() {
		$.ajax({
			url:"http://localhost:3000/classCount",
			type:"get",
			data:{page:0, name:$("#className").val()},
			success:function(count){
				loadPage2(count);
			},
			error:function(){
				alert("에러");
			}
		}); 
	}
	//paging class 처리
	function loadPage2( totalCount ) {
	
		let pageSize = 10;
		let nowPage = 1;
		
		let _totalPages = totalCount / pageSize;
		if(totalCount % pageSize > 0){
			_totalPages++;
		}
		$(".classPagination").twbsPagination('destroy'); //페이지 갱신: 초기화
		
		$(".classPagination").twbsPagination({
		//	startPage: 1,
			totalPages: _totalPages,
			visiblePages: 10,
			first:'<span sria-hidden="true">«</span>',
			prev:"이전",
			next:"다음",
			last:'<span sria-hidden="true">»</span>',
			initiateStartPageClick:false,		// onPageClick 자동 실행되지 않도록 한다
			onPageClick:function(event, page){
				nowPage = page;
			//	alert('nowPage:' + page);
				classlist( page - 1 );
			}
		});	
	}
	// 검색했을때 리스트
	$("#btnClassSearch").on("click", function () { 
		classlist(0);
	    countClassList();
	});
}); 



//----------------------문의사항----------------------------



	$("#goQnaList").click(function(){
		$(".card-header").text("QnA List");
		$("#managerPage").text("QnA List");
		adminNoticeCheck();
	});

	function adminNoticeCheck() {
		$("#layoutSidenav_content").hide();
		$("#noticeCheckCheck").show();
		let loginid;

		noticeListData(0);

		noticeListCount();
		
		//seq받아오기
		let urlParams = location.search.split(/[?&]/).slice(1).map(function(paramPair) {
		    return paramPair.split(/=(.+)?/).slice(0, 2);
		}).reduce(function(obj, pairArray) {
		    obj[pairArray[0]] = pairArray[1];
		    return obj;
		}, {});
	}
	function noticeListData( pNumber ) {
		
		$.ajax({
			url:"http://localhost:3000/noticeListData",
			type:"get",
			data:{ page:pNumber, choice:$("#_choice").val(), search:$("#_searchWord").val() },
			success:function( list ){
				//alert('success');
				//alert(list);
				
				
				$(".list_col").remove();
			
				$.each(list, function (i, val) {
					let app = "<tr class='list_col'>"
								+ "<td>" + (i + 1) + "</td>"
								+ "<td>";
								
						if(val.del == 0){	// 삭제되지 않은 글	
							app += "<a href='javascript:;' id='_seq' value='"+val.noticeNum+"'>&nbsp;" 
							+ val.nTitle + "</a>";
						}else{				// 삭제된 글
							app += "<font color='#ff0000'>* 이 글은 작성자에 의해서 삭제되었습니다 *</font>";
						}
						app += "</td>";
						
						app += "<td>" + val.username + "</td>";
						app += "<td>" + val.email + "</td>"; 
						app += "</tr>";
							
					$("#noticeTable").append(app);	
				});	
				
				
			},
			error:function(){
				alert('error');
			}
		});
	}

	//글의 총수를 취득
	function noticeListCount() {
		
		$.ajax({
			url:"http://localhost:3000/noticeListCount",
			type:"get",
			data:{ page:0, choice:$("#_choice").val(), search:$("#_searchWord").val() },
			success:function( count ){
				//alert('success');
				loadPage(count);
				
			},
			error:function(){
				alert('error');
			}		
		});
	}

	//paging 처리
	function loadPage( totalCount ) {

		let pageSize = 10;
		let nowPage = 1;
		
		let _totalPages = totalCount / pageSize;
		if(totalCount % pageSize > 0){
			_totalPages++;
		}
		$(".pagination").twbsPagination('destroy'); //페이지 갱신: 초기화
		
		$(".pagination").twbsPagination({
		//	startPage: 1,
			totalPages: _totalPages,
			visiblePages: 10,
			first:'<span sria-hidden="true">«</span>',
			prev:"이전",
			next:"다음",
			last:'<span sria-hidden="true">»</span>',
			initiateStartPageClick:false,		// onPageClick 자동 실행되지 않도록 한다
			onPageClick:function(event, page){
				nowPage = page;
			//	alert('nowPage:' + page);
				noticeListData( page - 1 );
			}
		});	
	}

	//아이디..
/* 	$(document).ready(function () {

		let login = sessionStorage.getItem("login");
		let json = JSON.parse(login); // String -> json
		//alert(json.id);
		let loginid = json.id;
		$("#_wid").val(json.id);	
	});	
		 */
	//검색	
	$(document).on("click", "#btnSearch", function () {


		
			noticeListData(0);

			noticeListCount();
		
	});
	//디테일 show up
	$(document).on("click", "#_seq", function () { 
		var tseq=$(this).attr('value');
		
		$.ajax({
			url:"http://localhost:3000/noticeDetail",
			type:"get",
			data:{seq:tseq },
			success:function( bbs ){
				//alert('success');
				
				$("#_noticeNum").val(bbs.noticeNum);
				$("#_memNum").val(bbs.memNum);
				$("#_username").val(bbs.username);
				$("#_ntitle").val(bbs.nTitle);
				$("#_ncontent").val(bbs.nContent);
				$("#_wdate").val(bbs.wDate);
				$("#_email").val(bbs.email);
				
				$("#detailModal").modal('show');
			},
			error:function(){
				alert('error');
			}		
			
			});
		
		});

	//답변클릭시 나오는 행
	let reply = "<tr id='replyTr'><th>답변</th><td><textarea rows='10' cols='30' id='replyMessage'name='message'></textarea></td></tr>";
	//답변 버튼 클릭 
	$(document).on("click", "#answerbtn", function () { 

		
					
		$("#detailTable").append(reply);	
		
		$('#answerbtn').hide(); //답변클릭시 답변버튼 지움
		
		$(".modal-footer").append("<button type=\"button\" class=\"btn btn-secondary\" id=\"answerAf\">답변완료</button>");	
		
	});



	//모달 닫기 버튼
	$(document).on("click", "#closebtn", function () { 
		$('#replyTr').remove();
		$('#answerAf').remove();
		$('#answerbtn').show();
		$('#detailModal').modal('hide');
		adminNoticeCheck();
	});

	</script> 
	<!-- 이메일 -->
	<script type="text/javascript">
		
		$(document).ready(function() {
			emailjs.init("user_ZyFYDtGep3QSZfIgncD2e");		
	       
			$(document).on("click", '#answerAf', function(){       	 
				$(this).remove();
				
				let fullName = document.getElementById("_username").value;
			    let userEmail = document.getElementById("_email").value;
			    let userMessage = document.getElementById("replyMessage").value;
				
	          var templateParams = {	
	          //각 요소는 emailJS에서 설정한 템플릿과 동일한 명으로 작성!
	                username: fullName,
	                email: userEmail,
	                message: userMessage
	           				};
	                    
	                	
	         emailjs.send('service_9lc0w1h', 'template_2s4zzav', templateParams)
	         //emailjs.send('service ID', 'template ID', 보낼 내용이 담긴 객체)
	         	    .then(function(response) {
	         	    	alert('success');
	         	       console.log('SUCCESS!', response.status, response.text);
	         	     
	         	    }, function(error) {
	         	       console.log('FAILED...', error);
	         	    });
	         	       
	         $("#detailModal").modal('hide');
				
	         $.ajax({
	  	 		url:"http://localhost:3000/noticeAnswerAf",
	  	 		type:"get",
	  	 		data:{seq:$('#_noticeNum').val() },
	  	 		success:function( data ){
	  	 			alert('success');

	  	 			adminNoticeCheck();
	  	 			location.reload(true);
	  	 			
	  	 		},
	  	 		error:function(){
	  	 			alert('error');
	  	 			}
	  	 	});
	         
	         
	        });
		  });


		</script>
</body>
</html>